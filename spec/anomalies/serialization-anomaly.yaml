name: "Serialization Anomaly"
cases:
  - setup:
      - CREATE TABLE mytab (class INT, value INT)
      - INSERT INTO mytab VALUES (1, 10)
      - INSERT INTO mytab VALUES (1, 20)
      - INSERT INTO mytab VALUES (2, 100)
      - INSERT INTO mytab VALUES (2, 200)
    events:
      - timestamp: "timestamp-1"
        session: "session-1"
        statements:
          - sql: "BEGIN TRANSACTION"
          - sql: "SELECT SUM(value) FROM mytab WHERE class = 1"
            legal_results:
              - result: 30
      - timestamp: "timestamp-1"
        session: "session-2"
        statements:
          - sql: "BEGIN TRANSACTION"
          - sql: "SELECT SUM(value) FROM mytab WHERE class = 2"
            legal_results:
              - result: 300
      - timestamp: "timestamp-2"
        session: "session-1"
        statements:
          - sql: "INSERT INTO mytab VALUES (2, 300)"
      - timestamp: "timestamp-2"
        session: "session-2"
        statements:
          - sql: "INSERT INTO mytab VALUES (1, 30)"
    teardown:
      - DROP TABLE IF EXISTS mytab
